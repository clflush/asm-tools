#!/usr/sbin/sed -f
# -*- sed -*-
#
# Usage: instrument program.s > instrumented.s
#
# Instrument the program in program.s to print a trace of program
# execution to "trace.out".
# - Instrumentation is inserted after every control flow instruction,
#   and jump target.
# - The output file lists executed labels and ASM LOC.
# - Note when data addresses are used.

# global variable declaration at the top of the file
/^	\.file/ a\
	.comm   __tracer_fd,8,8
;

# data to open tracing output file before the .text section
/	.text/ i\
.TRACE0:\
	.string "w"\
.TRACE1:\
	.string "trace.out"
;

# code to open tracing output file after the start of execution
# Note: for now we're using 
/	.cfi_def_cfa_register 6/ a\
	movl	%edi, -20(%rbp)\
	movq	%rsi, -32(%rbp)\
	movl    $.TRACE0, %esi\
	movl    $.TRACE1, %edi\
	call    fopen\
	movq	%rax, __tracer_fd(%rip)\
	movq	__tracer_fd(%rip), %rax
;

# instrument every label after the start of execution
/	.cfi_def_cfa_register 6/,$ s/^\.\(L.*\):/.section	.data\
.TRACE\1:\
	.string "\1\\n"\
.section	.text\
.\1:\
        movq    __tracer_fd(%rip), %rax\
        movq    %rax, %rcx\
        movl    $6, %edx\
        movl    $1, %esi\
        movl    $.TRACE\1, %edi\
	call    fwrite/
;
